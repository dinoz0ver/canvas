<!DOCTYPE html>
<html>
<head>
  <title>Canvas</title>
  <meta charset="utf-8">
</head>
<link rel="stylesheet" type="text/css" href="canvas.css">
  <body>
    <canvas id="main">
    </canvas>
  </body>
  <script type="text/javascript" src="canvas.js"></script>
  <script type="text/javascript" src="frame.js"></script>
  <script type="text/javascript" src="assets/mario.js"></script>
  <script type="text/javascript" src="assets/mariosprite.js"></script>
  <script type="text/javascript">
  	var ISKEYPRESSED=false
  	var WHATKEYPRESSED=undefined
  	var ISCLICKED=false
  	var COLCLICK=undefined
  	var ROWCLICK=undefined
  	function getkey(event) {
  		console.log(event.code)
  		ISKEYPRESSED=true
  		WHATKEYPRESSED=event.code
  	}

  	function getmouseclick(event) {
  		console.log(Math.floor(event.offsetY/MULTIPLIER), Math.floor(event.offsetX/MULTIPLIER))
  		ROWCLICK=Math.floor(event.offsetY/MULTIPLIER)
  		COLCLICK=Math.floor(event.offsetX/MULTIPLIER)
  		ISCLICKED=true
  	}

  	document.addEventListener("keydown", getkey)
  	CANVAS.addEventListener("mousedown", getmouseclick)

  </script>
  <script type="text/javascript">

    var current_style = [0,0,0];

    function set_style(ctx, color) {
      ctx.fillStyle = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
      current_style = color;
    }

    var background = CANVAS_CTX.createImageData(WIDTH, HEIGHT).data;

    function clear_screen(color) {
      if (!arraysEqual(color, current_style)) {
        set_style(TMP_CTX, color);
        TMP_CTX.fillRect(0, 0, WIDTH, HEIGHT);
        let new_background = TMP_CTX.getImageData(0, 0, WIDTH, HEIGHT).data;
        background.set(new_background);
      }
      CANVAS_DATA.data.set(background);
    }

    function draw_pixel(row, col, color) {
      if (color[3] == 0) {
        return;
      }
      let idx = (row*WIDTH+col)*4;
      CANVAS_DATA.data[idx+0] = color[0];
      CANVAS_DATA.data[idx+1] = color[1];
      CANVAS_DATA.data[idx+2] = color[2];
      CANVAS_DATA.data[idx+3] = color[3];
    }
  </script>

  <script type="text/javascript">
    (async() => {

    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // < your code goes here >
    // 
    // to do
    // -пока нету
    // done
    // -добавить список персонажей и написать там их статы, где находятся и как отрисовывать их
    // -добавить health бары прикреплённые к персонажу
    // -по нажатию кнопки вычитать hp
    // 
    // 
    // 
    // 
    // 

    console.log("Hello, world!");
    console.log(`Canvas width is ${WIDTH}`)
    console.log(`Canvas height is ${HEIGHT}`)

    var red = [255,0,0,255];
    var white = [255,255,255,255];
    var black = [0,0,0,255];
    var grey = [128,128,128,255];
    var blue = [0,0,255,255];
    var green = [0,255,0,255];
    var brown = [165,42,42,255];
    // clear_screen(grey);

    function copypic(colorlist, w, h, row, col) {	
		let i=0
		for (let rw=row; rw<row+h; rw++) {
			for (let cl=col; cl<col+w; cl++) {
				draw_pixel(rw, cl, colorlist[i])
				i++
			}
		}
    }

    function copyareapicc(colorlist, w, h, row, col, arearw, areacl, picw, reversedh=false) {
    	let arearow=arearw
    	let areacol=areacl
    	for (let rw=row; rw<row+h; rw++) {
    		for (let cl=col; cl<col+w; cl++) {
	    		let i=arearow*picw+areacol
	    		if (reversedh)
	    			draw_pixel(rw, w-(cl+1), colorlist[i])
	    		else
	    			draw_pixel(rw, cl, colorlist[i])
    			areacol++
    		}
    		arearow++
    		areacol=areacl
    	}
    }   

    function copyareapic(colorlist, w, h, row, col, arearw, areacl, picw, reversedh=false) {
    	for (let rw=0; rw<h; rw++) {
    		for (let cl=0; cl<w; cl++) {
    			let i=(arearw+rw)*picw+areacl+cl
    			if (reversedh)
    				draw_pixel(row+rw, w-1-cl+col, colorlist[i])
    			else
	    			draw_pixel(row+rw, col+cl, colorlist[i])
	    		// let i=arearow*picw+areacol
	    		// if (reversedh)
	    			// draw_pixel(rw, w-(cl+1), colorlist[i])
	    		// else
	    			// draw_pixel(rw, cl, colorlist[i])
    		}
    	}
    }

    function drawrect(row, col, color, width, height) {
    	for (let rw=0; rw<height; rw++) {
    		for (let cl=0; cl<width; cl++) {
    			draw_pixel(rw+row, cl+col, color)
    		}
    	}
    }

    function addcharacer(crctrs, newcrctr, names) {
    	crctrs[newcrctr.name]=newcrctr
    	names.push(newcrctr.name)
    	console.log(`new character: ${newcrctr}`)
    }

    function drawcharacters(crctrs, names) {
    	for (let i=0; i<names.length; i++) {
    		let crt=crctrs[names[i]]
    		copyareapic(crt.colorlist, crt.w, crt.h, crt.row , crt.col, crt.frames[crt.fri].arearw, crt.frames[crt.fri].areacl, crt.picw, crt.reversedh)
    		drawrect(crt.row-4, Math.floor(crt.col+crt.w/2-crt.maxhealth/2), brown, crt.maxhealth, 2)
    		drawrect(crt.row-4, Math.floor(crt.col+crt.w/2-crt.maxhealth/2), green, crt.currenthealth, 2)
    	}
    }

    function drawbuttons(btns) {
    	for (let i=0; i<btns.length; i++) {
			let btn=btns[i]
    		drawrect(btn.row, btn.col, btn.color, btn.width, btn.height)
    	}
    }

    function addbutton(btns, newbtn) {
    	btns.push(newbtn)
    	console.log(`new button: ${newbtn}`)
    }

    function bn(n,a,b) {
    	if (n>=a && n<=b) 
    		return true
    	return false
    }

    function isbuttonclicked(btn, row, col) {
    	if (bn(row, btn.row, btn.row+btn.height-1) && bn(col, btn.col, btn.col+btn.width-1))
    		return true
    	return false
    }

    function checkbuttonsclicked(btns, row, col, crts) {
    	for (let i=0; i<btns.length; i++) {
    		if (isbuttonclicked(btns[i], row, col)) {
    			btns[i].color=red
    		}
    	}
		if (isbuttonclicked(btns[0], row, col)) {
			if (crts.mario.currenthealth<=0) {
				return
			}
			crts.mario.currenthealth=crts.mario.currenthealth-2
			if (crts.mario.currenthealth<=0) {
				console.log("mario died lol")
				crts.mario.w=0
				crts.mario.h=0
				crts.mario.maxhealth=0
			}
		}
		if (isbuttonclicked(btns[1], row, col)) {
			if (crts.mario2.currenthealth<=0) {
				return
			}
			crts.mario2.currenthealth=crts.mario2.currenthealth-2
			if (crts.mario2.currenthealth<=0) {
				console.log("mario2 died lol")
				crts.mario2.w=0
				crts.mario2.h=0
				crts.mario2.maxhealth=0
			}
		}
    }


    let mariocl=41
    let mariorw=26
    let mariowdth=16
    let mariohght=28
    let framei=0
    let marioframe=0
    let goleft=false
    let marioarearw=0
    let marioareacl=0
    let mariopicw=56


    let buttons=[]
    	// args:
    	//   row, col, color, width, height
    let characters={}
    	// args:
    	//   colorlist, w, h, row, col, picw, reversedh, frames:[{arearw, areacl}, {arearw, areacl}, ...]
    let namescharacters=[]
    // drawbutton(10, 10, blue, 20, 10)
    addcharacer(characters, {
    	colorlist: MARIOSPRITE, 
    	w:16, 
    	h:28, 
    	row:mariorw, 
    	col:mariocl, 
    	picw:mariopicw, 
    	reversedh:goleft,
    	frames:[{arearw:0,areacl:0}, {arearw:0,areacl:20}, {arearw:0,areacl:40}],
    	fri:0,
    	name:"mario",
    	maxhealth:20,
    	currenthealth:20
    }, namescharacters)

    addcharacer(characters, {
    	colorlist: MARIOSPRITE, 
    	w:16, 
    	h:28, 
    	row:26, 
    	col:134, 
    	picw:mariopicw, 
    	reversedh:true,
    	frames:[{arearw:0,areacl:0}, {arearw:0,areacl:20}, {arearw:0,areacl:40}],
    	fri:0,
    	name:"mario2",
    	maxhealth:20,
    	currenthealth:20
    }, namescharacters)
    addbutton(buttons, {row:69, col:75, color:blue, width:20, height:10})
    addbutton(buttons, {row:69, col:96, color:blue, width:20, height:10})

    await start_recording()

    // for (let j=0;j<11;j++) {
    //   a=0
    //   for (let x=j*2; x<WIDTH; x++) {
    //     draw_pixel(a, x, red)
    //     draw_pixel(x, a, red)
    //     a+=1
    //   }
    // }


    await add_frame()

    while (true) {
		// if (ISKEYPRESSED) {
		// 	if (mariocl>0)
		// 	    if (WHATKEYPRESSED=="KeyA") {
		// 	    	mariocl--
		// 	    	goleft=true
		// 	    }
		// 	if (mariorw>0)
		// 		if (WHATKEYPRESSED=="KeyW")
		// 	    	mariorw--
		// 	if (mariocl<WIDTH-mariowdth)
		// 	    if (WHATKEYPRESSED=="KeyD") {
		// 	    	mariocl++
		// 	    	goleft=false
		// 	    }
		// 	if (mariorw<HEIGHT-mariohght)
		// 	    if (WHATKEYPRESSED=="KeyS")
		// 	    	mariorw++
		//     ISKEYPRESSED=false
		// }

		if (marioframe==15) {
			marioframe=0
		}

		clear_screen(black)
		if (marioframe>=10) {
			// marioarearw=0
			// marioareacl=40
			// mariopicw=56
			// copyareapic(MARIOSPRITE, mariowdth, mariohght, mariorw, mariocl, marioarearw, marioareacl, mariopicw, goleft)
			characters.mario.fri=2
			characters.mario2.fri=2
		}
		else if (marioframe>=5) {
			// marioarearw=0
			// marioareacl=20
			// mariopicw=56
			// copyareapic(MARIOSPRITE, mariowdth, mariohght, mariorw, mariocl, marioarearw, marioareacl, mariopicw, goleft)
			characters.mario.fri=1
			characters.mario2.fri=1
		}
		else if (marioframe>=0) {
			// marioarearw=0
			// marioareacl=0
			// mariopicw=56
			// copyareapic(MARIOSPRITE, mariowdth, mariohght, mariorw, mariocl, marioarearw, marioareacl, mariopicw, goleft)
			characters.mario.fri=0
			characters.mario2.fri=0
		}

		if (ISCLICKED) {
			checkbuttonsclicked(buttons, ROWCLICK, COLCLICK, characters)
			ISCLICKED=false
		}

		drawcharacters(characters, namescharacters)
		drawbuttons(buttons)
		
		// copypic(MARIOCOL, 16, 16, mariorw, mariocl)
		// copyareapic(MARIOSPRITE, mariowdth, mariohght, mariorw, mariocl, 0, 0, 56)
		await add_frame()
		marioframe++
		framei++
    }


    // draw_pixel(WIDTH/2, HEIGHT/2, red);

    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // </ your code goes here >
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 
    // 

    })().catch(console.error);

    // for (let a=255; a>0;a-=32) {
    //   red = [a, 0, 0]
    // }

    // a=0
    // b=31

    // квадраты красные вдаль
    // let n=0
    // let m=31
    // let a=255

    // for (let y=0;y<8;y++) {
    //   red = [a-=32, 0, 0]
    //   for (let v=n;v<m+1; v++) {
    //     draw_pixel(v,n,red)
    //     draw_pixel(v,m,red)

    //     draw_pixel(n,v,red)
    //     draw_pixel(m,v,red)
    //   }
    //   n+=2
    //   m-=2
    // }


// диагонали
    // red = [255, 0, 0]
    // b=0

    // for (let i=-1;i<15;i++) {
    // for (let j=0;j<11;j++) {
    //   a=0
    //   for (let x=j*3; x<32; x++) {
    //     draw_pixel(a, x, red)
    //     draw_pixel(x, a, red)
    //     a+=1
    //   }
    // }

  // for (let row = 0; row < 32; row++) {
  //   for (let col = 0; col < 32; col++) {

  //     draw_pixel(row, col, draw_static(row, col));

  //   }
  // }

// квадрат
    // for (i=0;i<32;i++) {
    //   draw_pixel(i,a,red)
    //   draw_pixel(i,b,red)
    //   for (x=2;x<30;x++) {
    //     draw_pixel(x,a+2,red)
    //     draw_pixel(x,b-2,red)
    //   }
    // }

    // for (i=0;i<32;i++) {
    //   draw_pixel(0,i,red)
    //   draw_pixel(31,i,red)
    //   for (x=2;x<30;x++) {
    //     draw_pixel(a+2,x,red)
    //     draw_pixel(b-2,x,red)
    //   }
    // }

  </script>

</html>
